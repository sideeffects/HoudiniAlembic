import string
import time
try:
    from hou import ui
except:
    ui = None

def BuildHierarchyRoot(rootNode):
    #For now delete the existing children.
    for child in rootNode.children():
        child.destroy()
    
    import _alembic_hom_extensions as ABC

    fileName = rootNode.evalParm('fileName')
    if not fileName:
        if ui:
            ui.displayMessage(title='No Filename',
                text='Please enter an Alembic file to load.',
                severity=hou.severityType.Warning)
        else:
            print 'No filename entered for Alembic scene.'
        return

    shopnet = rootNode.createNode('shopnet')
    abcProc = shopnet.createNode('vm_geo_alembic')

    buildSubnet = rootNode.evalParm('buildSubnet')

    tree = ABC.alembicGetSceneHierarchy(fileName, "")
    channelRefs = rootNode.evalParm('channelRef')

    pathList = [x for x in rootNode.evalParm('objectPath').strip('/').split('/') if x]
    
    for entry in tree[2]:
        WalkHierarchy(rootNode, rootNode,
                        '',
                        entry,
                        pathList,
                        buildSubnet,
                        abcProc,
                        channelRefs)
    if not channelRefs:
        PushParametersToChildren(rootNode)

_primitiveTypes = frozenset((
    'polymesh',
    'subdmesh',
    'curves',
    'nupatch',
    'points',
))

_sanitizeTable = None

def _sanitizeName(name):
    def valid(i):
        ch = chr(i)
        if ch.isalnum():
            return ch
        return '_'
    global _sanitizeTable
    if not _sanitizeTable:
        letters = ''.join([string.letters, string.digits, '_'])
        # Full alphabet
        alpha = ''.join(map(chr, range(256)))
        xlate = ''.join(map(valid, range(256)))
        _sanitizeTable = string.maketrans(alpha, xlate)
    name = string.translate(name, _sanitizeTable)
    if name[0].isdigit():
        name = '_' + name
    return name

def _setNodeName(node, name):
    try:
        node.setName(name, True)
    except:
        node.setName(_sanitizeName(name), True)
        

def ExpressionToParm(srcParm, dstParm, isString=False):
    relPath = dstParm.node().relativePathTo(srcParm.node())
    dstParm.setExpression('ch%s("%s/%s")' % (
            bool(isString)*'s', relPath, srcParm.name()),
            hou.exprLanguage.Hscript)

def _setupAbcGeo(geo, issubd):
    # We've just created an empty geometry node, we need to add the
    # properties we want.
    # Add mantra default properties
    #hou.hscript('opproperty -f -F Render %s mantra,prman* *rendersubd*,shop_geometrypath' % geo.path())
    parms = 'shop_geometrypath'
    if issubd:
        parms += ',*rendersubd*'
    hou.hscript('opproperty -f -F Render %s mantra,prman* %s' % (geo.path(), parms))

def WalkHierarchy(rootNode, parentNode, parentPath, childEntry,
                pathList, buildSubnet, abcProc, channelRefs):
    name, typeName, children = childEntry
    if pathList:
        if pathList[0] != name:
            return
        pathList = pathList[1:]

    currentPath = parentPath + '/' + name
    if typeName in _primitiveTypes:
        currentNode = parentNode.createNode('geo', run_init_scripts=False)
        subd = (typeName == 'subdmesh')
        _setupAbcGeo(currentNode, subd)
        if not buildSubnet:
            # Wire the geometry into the first subnetIndirectInput
            currentNode.setInput(0, parentNode.indirectInputs()[0])
        if subd:
            for parmname in ('vm_rendersubd', 'ri_rendersubd'):
                subdParm = currentNode.parm(parmname)
                if subdParm:
                    subdParm.set(1)
        _setNodeName(currentNode, name)

        proceduralParm = currentNode.parm('shop_geometrypath')
        if proceduralParm:
            relPath = currentNode.relativePathTo(abcProc)
            proceduralParm.set(relPath)

        sopNode = currentNode.createNode('alembic')
        
        relPath = sopNode.relativePathTo(rootNode)
        hou.hscript("opmultiparm %s 'abcName#' '%s/abcName#' 'hName#' '%s/hName#'" % (
                sopNode.path(), relPath, relPath))
        
        if channelRefs:
            ExpressionToParm(rootNode.parm('remapAttributes'),
                sopNode.parm('remapAttributes'),
                isString=True)
            ExpressionToParm(rootNode.parm('fileName'),
                sopNode.parm('fileName'),
                isString=True)
            ExpressionToParm(rootNode.parm('frame'), sopNode.parm('frame'))
            ExpressionToParm(rootNode.parm('fps'), sopNode.parm('fps'))
            ExpressionToParm(rootNode.parm('abcprim'), sopNode.parm('abcprim'))

        sopNode.parm('objectPath').set(currentPath)
        sopNode.parm('includeXform').set(0)
        sopNode.parm('groupnames').set('none')  # Don't build groups
    elif typeName == 'xform' or typeName == 'cxform':
        if buildSubnet:
            currentNode = parentNode.createNode('alembicxform')
        else:
            currentNode = rootNode.createNode('alembicxform')
            if currentNode.parent() == parentNode.parent():
                currentNode.setInput(0, parentNode)
        _setNodeName(currentNode, name)
        
        if channelRefs:
            ExpressionToParm(rootNode.parm('fileName'),
                    currentNode.parm('fileName'),
                    isString=True)
            if typeName != 'cxform':
                ExpressionToParm(rootNode.parm('frame'),
                        currentNode.parm('frame'))
                ExpressionToParm(rootNode.parm('fps'),
                        currentNode.parm('fps'))

        currentNode.parm('objectPath').set(currentPath)
        if typeName == 'cxform':
            currentNode.parm('abcConstant').set(1)

        for entry in children:
            WalkHierarchy(rootNode, currentNode, currentPath,
                        entry, pathList, buildSubnet, abcProc, channelRefs)
    elif typeName == 'camera':
        currentNode = parentNode.createNode('cam')
        if not buildSubnet:
            currentNode.setInput(0, parentNode.indirectInputs()[0])
        _setNodeName(currentNode, name)
        currentNode.addSpareParmTuple(rootNode.parm('fileName').parmTemplate(),
                ('Alembic',), True)
        currentNode.addSpareParmTuple(rootNode.parm('frame').parmTemplate(),
                ('Alembic',), True)
        currentNode.addSpareParmTuple(rootNode.parm('fps').parmTemplate(),
                ('Alembic',), True)
        
        if channelRefs:
            ExpressionToParm(rootNode.parm('fileName'),
                    currentNode.parm('fileName'),
                    isString=True)
            ExpressionToParm(rootNode.parm('frame'), currentNode.parm('frame'))
            ExpressionToParm(rootNode.parm('fps'), currentNode.parm('fps'))
        
        for parmName in (
                'focal',
                'near',
                'far',
                'focus',
                'winx',
                'winy',
                'winsizex',
                'winsizey',
                'aperture'):
             currentNode.parm(parmName).setExpression(
                    'pwd().alembicGetCameraDict(ch("fileName"), "%s", ch("frame")/ch("fps")).get("%s")' % (
                            currentPath, parmName), hou.exprLanguage.Python)
        
    
    else:
        return

def PushParametersToChildren(rootNode):
    now = time.time()
    WalkAndPush(rootNode, rootNode)

def _pushStringParm(name, fnode, tnode):
    tparm = tnode.parm(name)
    if tparm:
        fparm = fnode.parm(name)
        tparm.set(fparm.unexpandedString())

def _pushScalarParm(name, fnode, tnode):
    tparm = tnode.parm(name)
    if tparm:
        fparm = fnode.parm(name)
        try:
            expr = fparm.expression()
            tparm.setExpression(expr)
        except:
            tparm.set(fparm.eval())

def _pushRemapAttributesParm(fnode, tnode):
    tparm = tnode.parm('remapAttributes')
    if tparm:
        fparm = fnode.parm('remapAttributes')
        nparms = fparm.eval()
        tparm.set(nparms)
        for i in range(nparms):
            _pushStringParm('abcName%d' % (i+1), fnode, tnode)
            _pushStringParm('hName%d' % (i+1), fnode, tnode)

def WalkAndPush(rootNode, parentNode):
    for kid in parentNode.children():
        _pushStringParm('fileName', rootNode, kid)
        cxform = kid.parm('abcConstant')
        if not cxform or not cxform.eval():
            _pushScalarParm('frame', rootNode, kid)
            _pushScalarParm('fps', rootNode, kid)
            _pushScalarParm('abcprim', rootNode, kid)
            _pushRemapAttributesParm(rootNode, kid)
        WalkAndPush(rootNode, kid)

def GetObjectMenu():
   return ['b', 'b', 'c', 'c']
